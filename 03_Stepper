/*
	Program: DC Motor Card Interfacing with SST89E516RD
	Company : Logsun System
	Author  : Rupesh Khatpe
	Description:
		S1 = START
		S2 = STOP
		S3 = Forward
		S4 = Reverse
		S5 = Speed Increase
		S6 = Speed Decrease

	Connection:
		J2 (PORT1) → J14 (DC MOTOR Card)
		J3 (PORT2) → J15 (DC MOTOR Card)
*/

#include <reg51.h>   // Base 8051 header

// ---------- PCA REGISTER DEFINITIONS (for SST89E516RD) ----------
sfr CCON   = 0xD8;   // PCA Control Register
sfr CMOD   = 0xD9;   // PCA Mode Register
sfr CL     = 0xE9;   // PCA Counter Low
sfr CH     = 0xF9;   // PCA Counter High
sfr CCAPM1 = 0xDA;   // PCA Module 1 Mode Register
sfr CCAPM2 = 0xDB;   // PCA Module 2 Mode Register
sfr CCAP1H = 0xFA;   // PCA Module 1 Capture High
sfr CCAP2H = 0xFB;   // PCA Module 2 Capture High
// ---------------------------------------------------------------

// ---------- PIN CONNECTIONS ----------
sbit EN1   = P1^1;
sbit EN2   = P1^6;
sbit DEC   = P2^3;
sbit INC   = P2^2;
sbit REV   = P2^1;
sbit STOP  = P2^4;
sbit START = P2^0;
// -------------------------------------

// ---------- DELAY FUNCTION ----------
void delay(unsigned char val)
{
	unsigned int i, j;
	for(i = 0; i < val; i++)
		for(j = 0; j < 100; j++);
}
// -------------------------------------

// ---------- MAIN FUNCTION ----------
void main()
{
	unsigned char M_ON, val1 = 0x20, val2 = 0x42, dir;	

	M_ON = 0xCC;   // Motor initially off
	dir  = 2;      // Neutral direction
	P2   = 0xFF;   // Configure Port 2 as input

	while(1)
	{
		// --- START MOTOR ---
		if(START == 0 && M_ON == 0xCC)
		{
			dir  = 0;       // Forward
			M_ON = 0x00;    // Motor ON flag
			EN1  = 1;

			CCON = 0x40;    // Enable PCA counter
			CMOD = 0x00;    // Disable watchdog, PCA runs on Fosc/12

			CCAP1H = val1;  // Initial duty cycle
			CCAPM1 = val2;  // Enable PWM mode for Module 1
			CCAP2H = 0x00;
			CCAPM2 = val2;  // Enable PWM mode for Module 2
		}

		// --- STOP MOTOR ---
		if(STOP == 0 && (M_ON == 0x00 || M_ON == 0xCC))
		{
			dir  = 0;
			M_ON = 0xCC;
			EN1  = 0;

			CCON   = 0x40;
			CMOD   = 0x00;
			CCAP1H = 0x00;
			CCAPM1 = 0x00;
			CCAP2H = 0x00;
			CCAPM2 = 0x00;
			val1   = 0x20;
		}

		// --- REVERSE MOTOR ---
		else if(REV == 0 && M_ON == 0)
		{
			dir  = 1;
			M_ON = 0xCC;
			EN1  = 1;

			CCAP1H = 0x00;
			CCAP2H = val1;
		}

		// --- INCREASE SPEED ---
		else if(INC == 0 && (M_ON == 0 || M_ON == 0xCC))
		{
			if(val1 < 0xF0)
			{
				val1 = val1 + 1;
				delay(30);
			}
		}

		// --- DECREASE SPEED ---
		else if(DEC == 0 && (M_ON == 0 || M_ON == 0xCC))
		{
			if(val1 > 0x10)
			{
				val1 = val1 - 1;
				delay(30);
			}
		}

		// --- UPDATE DIRECTION OUTPUT ---
		if(dir == 0)
			CCAP1H = val1;  // Forward PWM
		if(dir == 1)
			CCAP2H = val1;  // Reverse PWM
	}
}
